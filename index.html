<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OoT Bingo → Bingosync</title>
  <style>
    :root {
      --bg:           #0d1117;
      --surface:      #161b22;
      --surface2:     #21262d;
      --border:       #30363d;
      --text:         #c9d1d9;
      --text-muted:   #8b949e;
      --gold:         #c9910a;
      --gold-light:   #f0c040;
      --green:        #3fb950;
      --red:          #f85149;
      --blue:         #58a6ff;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 1.5rem 4rem;
    }

    /* ── Header ── */
    header {
      text-align: center;
      padding: 3rem 0 2.5rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: clamp(1.75rem, 5vw, 2.75rem);
      font-weight: 700;
      color: var(--gold-light);
      letter-spacing: -0.5px;
    }

    header p {
      color: var(--text-muted);
      font-size: 1.05rem;
      margin-top: 0.4rem;
    }

    /* ── Cards ── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 1rem;
    }

    /* ── URL Input ── */
    .input-row {
      display: flex;
      gap: 0.75rem;
    }

    input[type="url"],
    input[type="text"] {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.875rem;
      padding: 0.6rem 0.9rem;
      outline: none;
      transition: border-color 0.2s;
      min-width: 0;
    }

    input:focus { border-color: var(--gold); }

    /* ── Buttons ── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: var(--gold);
      color: #0d1117;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      text-decoration: none;
      transition: background 0.15s, transform 0.1s;
      white-space: nowrap;
      user-select: none;
    }

    .btn:hover  { background: var(--gold-light); }
    .btn:active { transform: scale(0.97); }

    .btn.outline {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn.outline:hover { background: var(--surface2); color: var(--text); }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .actions {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    /* ── Status ── */
    .status-bar {
      margin-top: 0.9rem;
      font-size: 0.875rem;
      min-height: 1.4rem;
    }

    .status-bar.loading { color: var(--text-muted); }
    .status-bar.error   { color: var(--red); }
    .status-bar.success { color: var(--green); }

    /* ── Spinner ── */
    @keyframes spin { to { transform: rotate(360deg); } }

    .spinner {
      display: inline-block;
      width: 0.9rem;
      height: 0.9rem;
      border: 2px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: -0.15em;
      margin-right: 0.4rem;
    }

    /* ── Board Preview ── */
    .board-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      margin-bottom: 1.5rem;
    }

    .board-cell {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.68rem;
      min-height: 72px;
      padding: 0.45rem 0.4rem;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.3;
      transition: background 0.15s;
    }

    .board-cell:hover {
      background: var(--surface2);
    }

    /* ── Metadata strip ── */
    .meta-strip {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .meta-item {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .meta-item strong {
      color: var(--text);
    }

    /* ── JSON Output ── */
    .json-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    textarea {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Cascadia Code', 'Fira Code', 'Courier New', monospace;
      font-size: 0.78rem;
      height: 180px;
      padding: 0.75rem;
      resize: vertical;
      width: 100%;
      outline: none;
      transition: border-color 0.2s;
    }

    textarea:focus { border-color: var(--gold); }

    /* ── Divider ── */
    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 1.5rem 0;
    }

    /* ── Instructions ── */
    .step-list {
      list-style: none;
      counter-reset: steps;
    }

    .step-list li {
      counter-increment: steps;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
      padding: 0.5rem 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .step-list li + li {
      border-top: 1px solid var(--border);
    }

    .step-list li::before {
      content: counter(steps);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      background: var(--surface2);
      border: 1px solid var(--border);
      font-size: 0.75rem;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 0.1rem;
      color: var(--gold-light);
    }

    .step-list li strong { color: var(--text); }
    .step-list li a { color: var(--blue); text-decoration: none; }
    .step-list li a:hover { text-decoration: underline; }

    code {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: 'Cascadia Code', 'Fira Code', 'Courier New', monospace;
      font-size: 0.8em;
      padding: 0.1em 0.4em;
    }

    /* ── Callout ── */
    .callout {
      background: color-mix(in srgb, var(--gold) 8%, var(--surface));
      border: 1px solid color-mix(in srgb, var(--gold) 30%, var(--border));
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 1rem;
    }

    .callout strong { color: var(--gold-light); }

    /* ── Launch button ── */
    .btn-launch {
      font-size: 1rem;
      padding: 0.75rem 1.5rem;
    }

    /* ── Details / summary ── */
    details { margin-top: 0; }
    details summary { outline: none; }
    details summary:hover { color: var(--text); }
    details[open] summary { margin-bottom: 0; }

    /* ── Hidden ── */
    .hidden { display: none !important; }

    /* ── Footer ── */
    footer {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    footer a { color: var(--blue); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* ── Responsive ── */
    @media (max-width: 540px) {
      .input-row { flex-direction: column; }
      .btn { justify-content: center; }
      .board-cell { min-height: 58px; font-size: 0.6rem; }
    }
  </style>
</head>
<body>
<div class="container">

  <header>
    <h1>OoT Bingo → Bingosync</h1>
    <p>Generate JSON for Bingosync Custom Board</p>
  </header>

  <main>

    <!-- ── Step 1: URL Input ── -->
    <div class="card">
      <p class="card-title">Paste your OoT Bingo URL</p>
      <div class="input-row">
        <input
          type="url"
          id="bingo-url"
          placeholder="https://ootbingo.github.io/bingo/bingo.html?version=10.5.1&seed=155101&mode=normal"
          autocomplete="off"
          spellcheck="false"
        >
        <button class="btn" id="convert-btn" onclick="convert()">Convert</button>
      </div>
      <div id="status-bar" class="status-bar"></div>
    </div>

    <!-- ── Step 2: Board Preview + JSON ── -->
    <div class="card hidden" id="output-section">
      <p class="card-title">Board Preview &amp; JSON</p>

      <div class="meta-strip" id="meta-strip"></div>

      <div class="board-grid" id="board-preview"></div>

      <hr>

      <div class="json-label">
        <span>Bingosync Custom Goals JSON <span id="goal-count" style="color:var(--text-muted)"></span></span>
      </div>
      <textarea id="json-output" readonly spellcheck="false" aria-label="Bingosync custom goals JSON"></textarea>

      <div class="actions">
        <button class="btn" id="copy-btn" onclick="copyJson()">Copy JSON</button>
        <button class="btn outline" onclick="downloadJson()">Download JSON</button>
      </div>
    </div>

    <!-- ── Step 3: Create BingoSync Room ── -->
    <div class="card hidden" id="instructions-section">
      <p class="card-title">Create your Bingosync Room</p>

      <button class="btn btn-launch" id="launch-btn" onclick="openBingoSync()">
        Copy JSON &amp; Open Bingosync
      </button>
    </div>

  </main>

</div>

<script>
'use strict';

const BASE = 'https://ootbingo.github.io/bingo';

// ── Cached text so repeated conversions don't re-fetch ──
const _textCache = new Map();

async function fetchText(url) {
  if (_textCache.has(url)) return _textCache.get(url);
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status} fetching resource`);
  const text = await res.text();
  _textCache.set(url, text);
  return text;
}

// ── Script loading for seedrandom (modifies global Math) ──
let _seedrandomLoaded = false;

function loadScriptTag(src) {
  return new Promise((resolve, reject) => {
    const el = document.createElement('script');
    el.src = src;
    el.onload  = resolve;
    el.onerror = () => reject(new Error(`Failed to load script: ${src}`));
    document.head.appendChild(el);
  });
}

// ── Status bar ──
function setStatus(html, type = '') {
  const bar = document.getElementById('status-bar');
  bar.innerHTML = html;
  bar.className = 'status-bar' + (type ? ' ' + type : '');
}

// ── Show / hide sections ──
function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }

// ── Parse the OoT Bingo URL ──
function parseOoTUrl(raw) {
  const trimmed = raw.trim();
  if (!trimmed) throw new Error('Please enter an OoT Bingo URL.');

  let url;
  try { url = new URL(trimmed.includes('://') ? trimmed : 'https://' + trimmed); }
  catch { throw new Error('That doesn\'t look like a valid URL.'); }

  if (!url.hostname.includes('ootbingo.github.io')) {
    throw new Error('URL must come from ootbingo.github.io.');
  }

  const version = url.searchParams.get('version');
  const seedStr = url.searchParams.get('seed');
  const mode    = url.searchParams.get('mode') || 'normal';

  if (!version) throw new Error('URL is missing the "version" parameter.');
  if (!seedStr)  throw new Error('URL is missing the "seed" parameter.');

  const seed = parseInt(seedStr, 10);
  if (!Number.isFinite(seed)) throw new Error('"seed" is not a valid number.');

  return { version, seed, mode };
}

// ── Fetch version → path mapping ──
async function getVersionPath(version) {
  const text = await fetchText(`${BASE}/api/v1/available_versions.json`);
  const data = JSON.parse(text);
  const path = data.versions[version];
  if (!path) {
    const available = Object.keys(data.versions).slice(0, 8).join(', ');
    throw new Error(`Version "${version}" was not found. Available versions include: ${available}…`);
  }
  return path;
}

// ── Execute a fetched script in a sandboxed Function and return a value ──
// This mirrors how generateBoard.js works on the official OoT Bingo site.
function execScript(scriptText, returnExpr) {
  // eslint-disable-next-line no-new-func
  return Function(`${scriptText}\n;\nreturn (${returnExpr});`)();
}

// ── Generate the board ──
async function generateBoard(version, seed, mode) {
  const versionPath = await getVersionPath(version);

  const goalListText = await fetchText(`${BASE}/${versionPath}/goal-list.js`);
  const goalList = execScript(goalListText, 'bingoList');
  if (!goalList) throw new Error('Goal list failed to load (bingoList is undefined).');

  // Ensure seedrandom is available in global scope for older generators
  if (!_seedrandomLoaded) {
    try {
      await loadScriptTag(`${BASE}/lib/seedrandom-min.js`);
      _seedrandomLoaded = true;
    } catch {
      // Non-fatal — modern generator bundles include seedrandom internally
    }
  }

  const generatorText = await fetchText(`${BASE}/${versionPath}/generator.js`);

  // The generator exposes either BingoLibrary.ootBingoGenerator (v9+)
  // or a bare ootBingoGenerator global (older versions).
  const generatorFn = execScript(
    generatorText,
    `typeof BingoLibrary !== "undefined" && typeof BingoLibrary.ootBingoGenerator === "function"
       ? BingoLibrary.ootBingoGenerator
       : typeof ootBingoGenerator !== "undefined"
         ? ootBingoGenerator
         : undefined`
  );

  if (typeof generatorFn !== 'function') {
    throw new Error('Could not find the generator function. This version may be unsupported.');
  }

  const board = generatorFn(goalList, { seed, mode, lang: 'name' });

  // The generator returns a 1-indexed array (index 0 is unused metadata).
  // Each element is a goal object with at least a .name property.
  if (!Array.isArray(board)) {
    throw new Error('Generator returned an unexpected result format.');
  }

  // Determine offset: some older versions are 0-indexed
  const startIdx = board[0] && board[0].name ? 0 : 1;
  const rawGoals = board.slice(startIdx, startIdx + 25);

  if (rawGoals.length !== 25) {
    throw new Error(`Expected 25 goals but found ${rawGoals.length}. The version format may be unsupported.`);
  }

  return rawGoals.map(g => ({ name: typeof g === 'string' ? g : g.name }));
}

// ── Render the 5×5 board preview ──
function renderBoard(goals) {
  const grid = document.getElementById('board-preview');
  grid.innerHTML = '';
  goals.forEach(goal => {
    const cell = document.createElement('div');
    cell.className = 'board-cell';
    cell.textContent = goal.name;
    cell.title = goal.name;
    grid.appendChild(cell);
  });
}

// ── Main convert handler ──
async function convert() {
  const rawUrl = document.getElementById('bingo-url').value;
  const btn    = document.getElementById('convert-btn');

  hide('output-section');
  hide('instructions-section');

  let params;
  try {
    params = parseOoTUrl(rawUrl);
  } catch (err) {
    setStatus('❌ ' + err.message, 'error');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Converting…';
  try {
    const goals = await generateBoard(params.version, params.seed, params.mode);

    // Render board
    renderBoard(goals);

    // Metadata strip
    const strip = document.getElementById('meta-strip');
    strip.innerHTML = `
      <span class="meta-item">Version <strong>${escHtml(params.version)}</strong></span>
      <span class="meta-item">Seed <strong>${params.seed}</strong></span>
      <span class="meta-item">Mode <strong>${escHtml(params.mode)}</strong></span>
    `;

    // JSON output
    const json = JSON.stringify(goals, null, 2);
    document.getElementById('json-output').value = json;
    document.getElementById('goal-count').textContent = `(${goals.length} goals)`;

    // Show sections
    show('output-section');
    show('instructions-section');
    setStatus('', '');

    // Scroll to results
    document.getElementById('output-section').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Reflect params in URL so the page is shareable
    const pageUrl = new URL(window.location.href);
    pageUrl.searchParams.set('version', params.version);
    pageUrl.searchParams.set('seed',    String(params.seed));
    pageUrl.searchParams.set('mode',    params.mode);
    window.history.replaceState(null, '', pageUrl);

  } catch (err) {
    setStatus('❌ ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Convert';
  }
}

// ── Copy JSON to clipboard ──
async function copyJson() {
  const text = document.getElementById('json-output').value;
  const btn  = document.getElementById('copy-btn');
  if (!text) return;

  try {
    await navigator.clipboard.writeText(text);
  } catch {
    // Fallback for browsers without clipboard API
    const ta = document.getElementById('json-output');
    ta.select();
    document.execCommand('copy');
  }

  const orig = btn.textContent;
  btn.textContent = '✓ Copied!';
  btn.classList.add('outline');
  setTimeout(() => {
    btn.textContent = orig;
    btn.classList.remove('outline');
  }, 2000);
}

// ── Copy JSON + open BingoSync in one click ──
async function openBingoSync() {
  const text = document.getElementById('json-output').value;
  if (!text) return;

  // Copy to clipboard first
  try {
    await navigator.clipboard.writeText(text);
  } catch {
    const ta = document.getElementById('json-output');
    ta.select();
    document.execCommand('copy');
  }

  // Open BingoSync in a new tab
  window.open('https://bingosync.com', '_blank', 'noopener,noreferrer');

  // Update button temporarily
  const btn = document.getElementById('launch-btn');
  const orig = btn.textContent;
  btn.textContent = '✓ Opened! Paste the JSON on Bingosync';
  btn.classList.add('outline');
  setTimeout(() => {
    btn.innerHTML = 'Copy JSON &amp; Open Bingosync';
    btn.classList.remove('outline');
  }, 4000);
}

// ── Download JSON as a file ──
function downloadJson() {
  const text = document.getElementById('json-output').value;
  if (!text) return;

  const params  = new URL(window.location.href).searchParams;
  const seed    = params.get('seed')    || 'unknown';
  const version = params.get('version') || 'unknown';
  const mode    = params.get('mode')    || 'normal';

  const blob = new Blob([text], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `oot-bingo-${version}-${mode}-${seed}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ── Utility: escape HTML for safe insertion ──
function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// ── Auto-load from URL params on page load ──
function autoLoad() {
  const params  = new URL(window.location.href).searchParams;
  const version = params.get('version');
  const seed    = params.get('seed');
  const mode    = params.get('mode') || 'normal';

  if (version && seed) {
    const syntheticUrl =
      `https://ootbingo.github.io/bingo/bingo.html?version=${encodeURIComponent(version)}&seed=${encodeURIComponent(seed)}&mode=${encodeURIComponent(mode)}`;
    document.getElementById('bingo-url').value = syntheticUrl;
    convert();
  }
}

// ── Allow Enter key to trigger conversion ──
document.getElementById('bingo-url').addEventListener('keydown', e => {
  if (e.key === 'Enter') convert();
});

// Run auto-load after DOM is ready
autoLoad();
</script>
</body>
</html>
